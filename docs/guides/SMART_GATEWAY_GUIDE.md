# ⚡ CloudChan 智能网关指南（测速、排序、探测、清理）

本文档介绍 CloudChan 的网关系统如何工作：网关从哪里来、如何测速与排序、如何探测更多节点、以及如何清理长期不可用网关。

## 1. 相关代码位置

- 前端配置：`cloudchan/config.js`
- 网关弹窗与测速逻辑：`cloudchan/ui.js`

核心配置在 [config.js](../../cloudchan/config.js)：
- `DEFAULT_GATEWAYS`：默认精选网关（带优先级与地区）
- `PUBLIC_GATEWAY_SOURCES`：公共网关列表数据源（用于“探测更多节点”）
- `GATEWAY_TEST`：测速参数与短期缓存
- `GATEWAY_HEALTH`：健康追踪、评分与清理规则

## 2. 网关列表从哪里来？

CloudChan 的网关来源分为三类：

1) **默认精选网关（内置）**
- 适合开箱即用
- 一般带 `priority`（优先级越小越靠前）

2) **用户新增网关（浏览器本地缓存）**
- 你在 UI 中添加的网关会保存到 localStorage
- 下次打开页面会自动合并到默认列表

3) **探测得到的公共网关（在线获取）**
- 点击“探测”会从 `PUBLIC_GATEWAY_SOURCES` 拉取公开网关列表
- 会进行测速/过滤后再展示或合并

## 3. 网关测速是怎么做的？

测速的核心目标是回答两件事：
- 这个网关是否可用？
- 可用的话，大概有多快（延迟）？

关键参数（见 `CONFIG.GATEWAY_TEST`）：
- `TIMEOUT`：单个网关测试超时
- `CONCURRENT_LIMIT`：并发测速数量
- `RETRY_TIMES` / `RETRY_DELAY`：失败重试策略
- `CHECK_CACHE_EXPIRY`：短期测速缓存时间（默认 10 分钟）

## 4. 健康追踪与“清理长期不可用网关”

CloudChan 会把每个网关的历史结果写入“健康追踪缓存”（默认 30 天），并按规则判断是否建议清理。

常见的清理触发条件（见 `CONFIG.GATEWAY_HEALTH.CLEANUP`）：
- 失败次数过多
- 连续失败次数过多
- 长时间没有成功访问
- 健康分数过低

说明：
- 默认网关（通常 `priority <= 10`）不会被自动清理影响，以避免把“基础可用”删空
- 你可以在配置里关闭清理或调整阈值

## 5. “隐藏不可用”开关

在网关弹窗内勾选“隐藏不可用”后：
- 仅展示测速为可用的网关
- 偏好会保存在 localStorage，下次自动生效

## 6. 常见问题

### Q1：为什么网关弹窗一打开就有结果？
A：命中了短期测速缓存。你可以访问 `/clear-cache.html` 清缓存后重测。

### Q2：为什么有些网关时好时坏？
A：公共网关本身就是波动的（限流、节点负载、跨境链路等）。建议保留多个备用网关，并定期使用“清理”。

### Q3：探测失败怎么办？
A：公共网关列表源可能临时不可用。你可以稍后重试，或手动添加你信任的网关。

